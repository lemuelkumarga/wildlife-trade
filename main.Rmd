---
title: "Identifying Major Players in Endangered Wildlife Trade"
author: '<span class="meta">Lemuel Kumarga</span>'
date: '<span class="meta">May 2018</span>'
always_allow_html: yes
knit: (function(inputFile, encoding) { source("shared/knit.R"); knitter(inputFile, encoding) })
---

```{r echo=FALSE, warning=FALSE, results='hide'}
packages <- c("knitr")
tmp <- lapply(packages, library, character.only = TRUE)

# Set images globally
opts_chunk$set(fig.align='center', fig.height = 4, fig.width = 7)
read_chunk("main.R")
  
```

## Problem Description

Since the Stone Age, mankind has turned to nature for food, commerce and companionship. Our impact back then was minimal as resources were consumed at sustainable rates. However, over the past few decades, nature is increasingly under threat from overconsumption and excess capitalism. Our planet is facing multiple challenges on the environmental front, ranging from global warming to forest degradation. 

One corrosive impact of our greed is the shrinking wildlife diversity and population. In 2000, IUCN counted a total of around <a href="https://portals.iucn.org/library/sites/library/files/documents/RL-2000-001.pdf" target="_blank">10,000 endangered species</a>. By 2017, this number has doubled to <a href="https://www.statista.com/statistics/269910/red-list-endangered-animals-2010-and-2000/" target="_blank">24,431 species</a>. In the face of such overwhelming statistics, it is imperative for us to take action and protect these species from extinction. In this project, we will aim to contribute by using data from both <a href="https://www.cites.org/eng/disc/what.php" target="_blank">CITES (Convention on Internation Trade in Endangered Species of Wild Fauna and Flora)</a> and <a href="http://www.iucnredlist.org/about/introduction" target="_blank">IUCN</a> <span class="hl">to identify the major players behind endangered wildlife trade</span>.

To skip the methodology and proceed straight to the results, please click <a href="#summary-of-results">here</a>.

## Preliminaries

First load the necessary packages for this exercise.
```{r}
<<init>>

si <- sessionInfo()
base_pkg_str <- paste0("Base Packages: ",paste(si[["basePkgs"]], collapse=", "))
attached_pkg_str <- paste0("Attached Packages: ",paste(names(si[["otherPkgs"]]), collapse=", "))
cat(paste0(base_pkg_str,"\n",attached_pkg_str))
```

## About the Data

We will be using wildlife trade data from CITES for the period of 2001 to 2015, with the following caveats:

* 2016 and 2017 were excluded due to data lag in the year of analysis (2018). (See <a href="https://trade.cites.org/cites_trade_guidelines/en-CITES_Trade_Database_Guide.pdf" target="_blank">Section 1.2.2 of the guide</a> for more details.)
* Analysis will be restricted to trades whose sources originated from the wild.

Listed below is an overview of the CITES data:
```{r}
<<data-overview>>
  
pander(cols_summary, caption='Wildlife Trade Data - For more info, please visit <a href="https://trade.cites.org/" target="_blank">CITES Trade Database</a>')
```

From the <a href="https://trade.cites.org/cites_trade_guidelines/en-CITES_Trade_Database_Guide.pdf" target="_blank">guide</a> and the above summary, we know that:

1. Each row corresponds to the <span class="hl">total trade</span> between two countries for a particular species at a particular term. This is contrary to popular belief that each row corresponds to one shipment. (See Section 3.1 for more details.)
2. Not all animals in the data are endangered. For example, the <a href="https://en.wikipedia.org/wiki/White-tailed_eagle" target="_blank">white-tailed eagle (Haliaeetus albicilla)</a> is specified as <span class="hl">Least Concern</span> on the IUCN Red List.
3. Terms are <span class="hl">heterogenous</span>. For example, some quantities correspond to bodies, while others correspond to feathers.
4. Units are also <span class="hl">varied</span>. Quantities can be quoted as distinct counts (i.e. blank unit), or in terms of weight/volume/qualitative units.

As can be seen, some pre-processing would be required before our analysis can proceed. In particular, (3) and (4) need to be standardized to allow comparison across species.

## Pre-Processing

### Restricting the Species

#### Animals Only

In the data, taxonomies with blank <span class="hl">Classes</span> are plants. For the purposes of this analysis, these records (or rows) will be excluded from the dataset.

```{r}
pre_clean <- nrow(dataset)
post_clean_str <- function () {
  post_clean <- nrow(dataset)
  cat(sprintf("%i rows removed (%i%% of total)",pre_clean - post_clean,floor((pre_clean - post_clean)/pre_clean * 100)))  
}

<<pp-restrict-animals>>

post_clean_str()
```

#### Endangered Only

Endangered status of species are located in the IUCN Red List database. Due to licensing restrictions, the data could not be uploaded for public view. However, one is free to create an account and download the csv from <a href="http://www.iucnredlist.org/search/saved?id=90695" target="_blank">here</a>.

By integrating the IUCN data, we can subsequently filter non-endangered species out of the CITES dataset.
```{r}
<<pp-restrict-endanger>>

post_clean_str()
```

### Standardizing the Terms

After restricting the dataset to only endangered species, we need to standardize all the terms below into universal <span class="hl">animal units</span>:

```{r}
<<pp-terms-overview>>

output_str <- "List of Terms:\n" %>%
               paste0(paste0(unique(dataset$Term), collapse=", "),"\n\n") %>%
               paste0("List of Units:\n") %>%
               paste0(paste0(unique((dataset %>% 
                       mutate(Unit = ifelse(Unit == "","count",Unit)))$Unit), 
                       collapse=", "))

cat(output_str)
```

#### Scientific Units
The first thing to note is that not all of the <span class="hl">units</span> are SI (e.g. <span class="hl">cm, g and litres</span>). This is relatively straightforward to fix:

```{r}
pre_clean <- nrow(dataset %>% group_by(Term, Unit) %>% summarise())
post_clean_str <- function () {
  post_clean <- nrow(dataset %>% group_by(Term, Unit) %>% summarise())
  cat(sprintf("%i term-unit pair%s remaining (%i%% of total removed)",
              post_clean,
              ifelse(post_clean == 1,"","s"),
              floor((pre_clean - post_clean)/pre_clean * 100)))
}

<<pp-to-si>>

post_clean_str()
```

#### One Term, One Unit
Another issue is that one term can be recorded in different units. Consider the term <span class="hl">bodies</span>, which were recorded in counts, kilograms and even metres:

```{r}
<<pp-term-unit-summary>>
  
output_tbl <- term_unit_counts %>%
              filter(Term == "bodies")

pander(output_tbl)
```

Ideally, we would convert kilograms of bodies into actual count by identifying species' weight. However, such methods are time-intensive, and fall outside the scope of this analysis. Therefore, we need to propose a conversion rule that is more manageable and yet still relatively accurate.

To standardize units for each term, we will first choose the target unit to convert to. This can be done by identifying the unit with the highest number of records.

```{r}
<<pp-term-unit-target>>
```

The tricky part comes in when we attempt to convert a quantity from a non-target unit to the target unit. During this step, we will assume that, <span class="hl">for each species, the median quantity traded in animal units is constant regardless of the terms/units they were specified in</span>. In other words, if the median quantity of elephant bodies traded is 2, and the median quantity of elephant bodies traded in kgs is 14,000, then the 2 elephant bodies are equivalent to 14,000 kgs.

This assumption allows us to convert quantities to the target unit using the following equation:

\[ q_{t} = \frac{q_{nt}}{m_{nt}} \times m_{t} \]

where <br>
\(q_{t}\) corresponds to the quantity traded (in target unit), <br>
\(q_{nt}\) corresponds to the quantity traded (in non-target unit), <br>
\(m_{nt}\) corresponds to the median quantity traded (in non-target unit), and <br>
\(m_{t}\) corresponds to the  median quantity traded (in target unit).

##### The Roll-Up Median Approach

One potential challenge with the above approach is the lack of data points for each species, term and unit triplet. To illustrate, consider the African bush elephant (Loxodonta africana) trades below:

```{r}
output_tbl <- dataset %>% 
              filter(Taxon == "Loxodonta africana") %>%
              left_join(target_unit, by=c("Term","Unit")) %>%
              filter(is.na(NumberOfUnits)) %>%
              group_by(Taxon, Term, Unit) %>%
              summarise(Records = n())

pander(head(output_tbl,5))
```

There is only a <span class="hl">single</span> data point whose term and unit are "bodies" and "kg"! Such minute sample size is not sufficient to calculate the median. To obtain larger sample sizes, a roll-up approach is required:

```{r}
# For documentation, please visit http://rich-iannone.github.io/DiagrammeR/graphviz_and_mermaid.html
grViz(paste0("
  digraph RollUp {

    # Default Specs
    graph [compound = true, nodesep = .5, ranksep = .25]
    node [fontname = '",def_font,"', fontsize = 14, fontcolor = '",bg_color,"', penwidth=0, color='",ltxt_color,"', style=filled]
    edge [fontname = '",def_font,"', fontcolor = '",ltxt_color,"', color='",ltxt_color,"']
    
    # Input Specs
    Inp [fillcolor = '",ltxt_color,"', label = '(Species s, Term t, Unit u)', shape = rectangle]

    # Conclude Specs
    node [shape = oval]
    Species_Y [label = 'Use the median quantity\nof Species s, Term t and Unit u.', fillcolor = '",get_color(1),"']
    Genus_Y [label = 'Use the median quantity\nof Genus g, Term t and Unit u.', fillcolor = '",get_color(2),"']
    Family_Y [label = 'Use the median quantity\nof Family f, Term t and Unit u.', fillcolor = '",get_color(3),"']
    Order_Y [label = 'Use the median quantity\nof Order o, Term t and Unit u.', fillcolor = '",get_color(4),"']
    Class_Y [label = 'Use the median quantity\nof Class c, Term t and Unit u.', fillcolor = '",get_color(5),"']
    Kingdom_Y [label = 'Use the median quantity\nof Term t and Unit u (across all).', fillcolor = '",txt_color,"']

    # Trigger Specs
    node [shape = diamond, fillcolor = '",bg_color,"', fontcolor = '",txt_color,"', penwidth = 1]
    Species_T [label = 'Does the Species s\nhave >=10 records\nfor the term t and unit u?']
    { rank = same; Species_T, Species_Y }
    Genus_T [label = 'Does g (the Genus of s)\nhave >=10 records\nfor the term t and unit u?']
    { rank = same; Genus_T, Genus_Y }
    Family_T [label = 'Does f (the Family of g)\nhave >=10 records\nfor the term t and unit u?']
    { rank = same; Family_T, Family_Y }
    Order_T [label = 'Does o (the Order of f)\nhave >=10 records\nfor the term t and unit u?']
    { rank = same; Order_T, Order_Y }
    Class_T [label = 'Does c (the Class of o)\nhave any record\nfor the term t and unit u?']
    { rank = same; Class_T, Class_Y }

    # Yes edges
    Inp -> Species_T
    edge [arrowhead = 'box', label = 'Yes']
    Species_T -> Species_Y
    Genus_T -> Genus_Y
    Family_T -> Family_Y
    Order_T -> Order_Y
    Class_T -> Class_Y
    
    # No edges
    edge [label = '     No']
    Species_T -> Genus_T
    Genus_T -> Family_T
    Family_T -> Order_T
    Order_T -> Class_T
    Class_T -> Kingdom_Y

  }
"), height=700)
```

To sum up the flowchart above, we will first count the number of records under the given species, term and unit. If the records are insufficient, we then "roll-up" and attempt to find the number of records for the genus associated with the species. This process continues until we have sufficient data points to calculate the median.

##### Managing Outliers

Another potential challenge of converting around the median is that outliers may be extremely high, thereby skewing the aggregate results towards certain records. To remedy this, we will floor the scaled quantity (\( q_{nt} / m_{nt} \)) of each record to the 5th percentile and cap it to the 95th percentile.

Using the following process, we can now convert all the terms to their respective standardized units.
```{r}
<<pp-term-unit-final>>

post_clean_str()
```

#### Well-Defined Terms

Let us now <span class="hl">convert each term to the universal animal unit</span>. Through observation, the terms can be differentiated into well-defined or ambiguous. A term is well-defined if it is consistent numerically across all animals and records. One good example would be tusk, since 2 of them are always the equivalent of 1 animal. 

Listed below are the terms we describe as well-defined:

```{r}
<<pp-term-well-defined-overview>>

output_str <- "Well-Defined Terms [with Number Per Live Animal]:\n"
wdt <- well_defined_terms %>%
       mutate(outputString = paste0(Term," [", perAnimal, "]"))
output_str <- output_str %>%
              paste0(paste0(wdt$outputString,collapse=", "))
  
cat(output_str)
```

To convert a well-defined term, we simply need to divide the quantity by the number of terms per animal:

```{r}
<<pp-term-well-defined-convert>>

post_clean_str()
```

#### Ambiguous Terms

The final piece of the jigsaw is to convert ambiguous terms. These terms, by nature of their names, are somewhat vague, and there exists no clear association between them and the number of animals. For example, how many ivory pieces make up an elephant? Depending on the sizes of the pieces, the numbers would differ record by record.

To simplify the conversion process, we will revisit our previous assumption when standardizing units of a term. Assuming that <span class="hl">across each species, the median quantity traded in live animal units is the same across any term</span>, ambiguous terms can be converted using the following equation:

\[ q_{animal} = \frac{q_{at}}{m_{at}} \times m_{animal} \]

where <br>
\(q_{animal}\) corresponds to the quantity of animals traded, <br>
\(q_{at}\) corresponds to the quantity traded (in ambiguous terms), <br>
\(m_{at}\) corresponds to the median quantity traded (in ambiguous terms), and <br>
\(m_{animal}\) corresponds to the median quantity of animals traded.

As before, medians are obtained through the <a href="#the-roll-up-median-approach">roll-up approach</a>, and outliers are managed by <a href="#managing-outliers">flooring and capping at the 5th and 95th percentile</a> respectively.

With this final step, we have reduced over 200 distinct term-unit pairs into a single animal unit!

```{r}
<<pp-term-ambiguous-convert>>

post_clean_str()
```

## Exploration

```{r}
<<exp-time>>

streamgraph_plot
```

```{r, fig.asp=0.35}
<<exp-purpose>>

waffle_plot
```

```{r}
<<exp-species>>

# Centerize the sunburst plot
htmlwidgets::onRender(
    sunburst_plot,
    "
    function(el, x) {
    $('.sunburst-chart').css('width', 'initial');
    $('.sunburst-chart').css('height', 'initial');
    $('.sunburst-chart').css('left', '50%');
    $('.sunburst-chart').css('transform', 'translate(-50%, 0)');
    }
    "
)

```

## Tracing Supply and Demand

### The Algorithm

### Following the Demand

### Finding the Supply

## Summary of Results

## Limitations

* Wild
* Unidentified Species

## References

